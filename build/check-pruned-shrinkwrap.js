"use strict";

require("source-map-support/register");

const _ = require('lodash');

const {
  asyncify
} = require('asyncbox');

const {
  fs,
  logger
} = require('appium-support');

const path = require('path');

const log = new logger.getLogger('ShrinkwrapValidator');

async function main() {
  const shrinkwrapPath = path.resolve('npm-shrinkwrap.json');

  if (!(await fs.exists(shrinkwrapPath))) {
    log.info('No shrinkwrap found. Skipping shrinkwrap check');
    return;
  }

  const shrinkwrap = JSON.parse(await fs.readFile(shrinkwrapPath));
  const backupShrinkwrap = JSON.parse(await fs.readFile(path.resolve('npm-shrinkwrap-backup.json')));
  log.info('Checking that pruned shrinkwrap is a subset of primary shrinkwrap');

  if (!_.isMatch(backupShrinkwrap, shrinkwrap)) {
    log.errorAndThrow('Pruned shrinkwrap (shrinkwrap with dev dependencies removed) is not a subset of the original npm-shrinkwrap.json');
  }

  log.info('Shrinkwrap check passed');
}

if (require.main === module) {
  asyncify(main);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNoZWNrLXBydW5lZC1zaHJpbmt3cmFwLmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiYXN5bmNpZnkiLCJmcyIsImxvZ2dlciIsInBhdGgiLCJsb2ciLCJnZXRMb2dnZXIiLCJtYWluIiwic2hyaW5rd3JhcFBhdGgiLCJyZXNvbHZlIiwiZXhpc3RzIiwiaW5mbyIsInNocmlua3dyYXAiLCJKU09OIiwicGFyc2UiLCJyZWFkRmlsZSIsImJhY2t1cFNocmlua3dyYXAiLCJpc01hdGNoIiwiZXJyb3JBbmRUaHJvdyIsIm1vZHVsZSJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWVELE9BQU8sQ0FBQyxVQUFELENBQTVCOztBQUNBLE1BQU07QUFBRUUsRUFBQUEsRUFBRjtBQUFNQyxFQUFBQTtBQUFOLElBQWlCSCxPQUFPLENBQUMsZ0JBQUQsQ0FBOUI7O0FBQ0EsTUFBTUksSUFBSSxHQUFHSixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFFQSxNQUFNSyxHQUFHLEdBQUcsSUFBSUYsTUFBTSxDQUFDRyxTQUFYLENBQXFCLHFCQUFyQixDQUFaOztBQUVBLGVBQWVDLElBQWYsR0FBdUI7QUFDckIsUUFBTUMsY0FBYyxHQUFHSixJQUFJLENBQUNLLE9BQUwsQ0FBYSxxQkFBYixDQUF2Qjs7QUFDQSxNQUFJLEVBQUUsTUFBTVAsRUFBRSxDQUFDUSxNQUFILENBQVVGLGNBQVYsQ0FBUixDQUFKLEVBQXdDO0FBQ3RDSCxJQUFBQSxHQUFHLENBQUNNLElBQUosQ0FBUyxnREFBVDtBQUNBO0FBQ0Q7O0FBQ0QsUUFBTUMsVUFBVSxHQUFHQyxJQUFJLENBQUNDLEtBQUwsQ0FBVyxNQUFNWixFQUFFLENBQUNhLFFBQUgsQ0FBWVAsY0FBWixDQUFqQixDQUFuQjtBQUNBLFFBQU1RLGdCQUFnQixHQUFHSCxJQUFJLENBQUNDLEtBQUwsQ0FBVyxNQUFNWixFQUFFLENBQUNhLFFBQUgsQ0FBWVgsSUFBSSxDQUFDSyxPQUFMLENBQWEsNEJBQWIsQ0FBWixDQUFqQixDQUF6QjtBQUNBSixFQUFBQSxHQUFHLENBQUNNLElBQUosQ0FBUyxtRUFBVDs7QUFDQSxNQUFJLENBQUNaLENBQUMsQ0FBQ2tCLE9BQUYsQ0FBVUQsZ0JBQVYsRUFBNEJKLFVBQTVCLENBQUwsRUFBOEM7QUFDNUNQLElBQUFBLEdBQUcsQ0FBQ2EsYUFBSixDQUFrQixrSEFBbEI7QUFDRDs7QUFDRGIsRUFBQUEsR0FBRyxDQUFDTSxJQUFKLENBQVMseUJBQVQ7QUFDRDs7QUFFRCxJQUFJWCxPQUFPLENBQUNPLElBQVIsS0FBaUJZLE1BQXJCLEVBQTZCO0FBQzNCbEIsRUFBQUEsUUFBUSxDQUFDTSxJQUFELENBQVI7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IHsgYXN5bmNpZnkgfSA9IHJlcXVpcmUoJ2FzeW5jYm94Jyk7XG5jb25zdCB7IGZzLCBsb2dnZXIgfSA9IHJlcXVpcmUoJ2FwcGl1bS1zdXBwb3J0Jyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXG5jb25zdCBsb2cgPSBuZXcgbG9nZ2VyLmdldExvZ2dlcignU2hyaW5rd3JhcFZhbGlkYXRvcicpO1xuXG5hc3luYyBmdW5jdGlvbiBtYWluICgpIHtcbiAgY29uc3Qgc2hyaW5rd3JhcFBhdGggPSBwYXRoLnJlc29sdmUoJ25wbS1zaHJpbmt3cmFwLmpzb24nKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHNocmlua3dyYXBQYXRoKSkpIHtcbiAgICBsb2cuaW5mbygnTm8gc2hyaW5rd3JhcCBmb3VuZC4gU2tpcHBpbmcgc2hyaW5rd3JhcCBjaGVjaycpO1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCBzaHJpbmt3cmFwID0gSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZShzaHJpbmt3cmFwUGF0aCkpO1xuICBjb25zdCBiYWNrdXBTaHJpbmt3cmFwID0gSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUoJ25wbS1zaHJpbmt3cmFwLWJhY2t1cC5qc29uJykpKTtcbiAgbG9nLmluZm8oJ0NoZWNraW5nIHRoYXQgcHJ1bmVkIHNocmlua3dyYXAgaXMgYSBzdWJzZXQgb2YgcHJpbWFyeSBzaHJpbmt3cmFwJyk7XG4gIGlmICghXy5pc01hdGNoKGJhY2t1cFNocmlua3dyYXAsIHNocmlua3dyYXApKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ1BydW5lZCBzaHJpbmt3cmFwIChzaHJpbmt3cmFwIHdpdGggZGV2IGRlcGVuZGVuY2llcyByZW1vdmVkKSBpcyBub3QgYSBzdWJzZXQgb2YgdGhlIG9yaWdpbmFsIG5wbS1zaHJpbmt3cmFwLmpzb24nKTtcbiAgfVxuICBsb2cuaW5mbygnU2hyaW5rd3JhcCBjaGVjayBwYXNzZWQnKTtcbn1cblxuaWYgKHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7XG4gIGFzeW5jaWZ5KG1haW4pO1xufSJdLCJmaWxlIjoiY2hlY2stcHJ1bmVkLXNocmlua3dyYXAuanMiLCJzb3VyY2VSb290IjoiLi4ifQ==
