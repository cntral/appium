"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _yamlJs = _interopRequireDefault(require("yaml-js"));

var _appiumSupport = require("appium-support");

var _validate = _interopRequireDefault(require("validate.js"));

var _handlebars = _interopRequireDefault(require("handlebars"));

var _lodash = _interopRequireDefault(require("lodash"));

var _asyncbox = require("asyncbox");

var _validator = require("./validator");

var _url = _interopRequireDefault(require("url"));

var _fancyLog = _interopRequireDefault(require("fancy-log"));

var _findRoot = _interopRequireDefault(require("find-root"));

const platformRanges = {
  xcuitest: ['9.3'],
  uiautomation: ['8.0', '9.3'],
  espresso: ['?'],
  uiautomator2: ['?'],
  uiautomator: ['4.3'],
  windows: ['10'],
  mac: ['?']
};
const appiumRanges = {
  xcuitest: ['1.6.0'],
  uiautomator2: ['1.6.0'],
  espresso: ['1.9.0'],
  windows: ['1.6.0'],
  mac: ['1.6.4']
};
const rootFolder = (0, _findRoot.default)(__dirname);

_handlebars.default.registerHelper('versions', function versionHelper(object, name, driverName) {
  if (!object) {
    return 'None';
  }

  if (!_lodash.default.isObject(object)) {
    object = {};
  }

  let min = object[name ? `${name}_min` : 'min'];
  let max = object[name ? `${name}_max` : 'max'];

  if (!min) {
    if (name === 'appium' && _lodash.default.isArray(appiumRanges[driverName])) {
      min = appiumRanges[driverName][0];
    } else if (name === 'platform' && _lodash.default.isArray(platformRanges[driverName])) {
      min = platformRanges[driverName][0];
    }
  }

  if (!max) {
    if (name === 'appium' && appiumRanges[driverName]) {
      max = appiumRanges[driverName][1];
    } else if (name === 'platform' && platformRanges[driverName]) {
      max = platformRanges[driverName][1];
    }
  }

  if (!min && !max) {
    return 'All';
  } else if (!max) {
    return `${min}+`;
  } else if (!min) {
    return `<= ${max}`;
  }

  return `${min} to ${max}`;
});

_handlebars.default.registerHelper('hyphenate', str => str.replace('_', '-'));

_handlebars.default.registerHelper('uppercase', str => str.toUpperCase());

_handlebars.default.registerHelper('capitalize', function capitalizeDriver(driverName) {
  switch (driverName.toLowerCase()) {
    case 'xcuitest':
      return 'XCUITest';

    case 'uiautomation':
      return 'UIAutomation';

    case 'uiautomator2':
      return 'UiAutomator2';

    case 'uiautomator':
      return 'UiAutomator';

    case 'espresso':
      return 'Espresso';

    default:
      return driverName.length === 0 ? driverName : driverName[0].toUpperCase() + driverName.substr(1);
  }
});

_handlebars.default.registerHelper('if_eq', function ifEq(a, b, opts) {
  if (a === b) {
    return opts.fn(this);
  } else {
    return opts.inverse(this);
  }
});

function getBaseHostname(fullUrl) {
  const baseUrl = _url.default.parse(fullUrl);

  return baseUrl.hostname;
}

_handlebars.default.registerHelper('base_url', function baseUrl(fullUrl) {
  return getBaseHostname(fullUrl);
});

_handlebars.default.registerHelper('client_url', function clientUrl(clientUrl) {
  if (!clientUrl) {
    return;
  }

  const createUrlString = function createUrlString(clientUrl, name = getBaseHostname(clientUrl)) {
    return `[${name}](${clientUrl})`;
  };

  if (!_lodash.default.isArray(clientUrl)) {
    return createUrlString(clientUrl);
  }

  let urlStrings = [];

  for (const item of clientUrl) {
    for (let [key, value] of _lodash.default.toPairs(item)) {
      key = key.toLowerCase();
      const urlStr = _validator.CLIENT_URL_TYPES[key] === 'hostname' ? createUrlString(value) : createUrlString(value, _validator.CLIENT_URL_TYPES[key]);
      urlStrings.push(urlStr);
    }
  }

  return urlStrings.join(' ');
});

async function registerSpecUrlHelper() {
  const routesFile = await _appiumSupport.fs.readFile(_path.default.resolve(rootFolder, 'node_modules', 'appium-base-driver', 'lib', 'protocol', 'routes.js'), 'utf8');
  const routesFileLines = routesFile.split('\n');

  _handlebars.default.registerHelper('spec_url', function specUrl(specUrl, endpoint) {
    if (!specUrl.includes('routes.js')) {
      return specUrl;
    }

    if (specUrl.startsWith('routes.js')) {
      specUrl = `https://github.com/appium/appium-base-driver/blob/master/lib/protocol/${specUrl}`;
    }

    specUrl = specUrl.split('#L')[0];
    endpoint = endpoint.replace('session_id', 'sessionId');
    endpoint = endpoint.replace('element_id', 'elementId');
    let index;

    for (const i in routesFileLines) {
      if (routesFileLines[i].includes(endpoint)) {
        index = parseInt(i, 10) + 1;
        break;
      }
    }

    if (_lodash.default.isUndefined(index)) {
      throw new Error(`Unable to find entry in 'appium-base-driver#routes' for endpoint '${endpoint}'`);
    }

    return `${specUrl}#L${index}`;
  });
}

async function generateCommands() {
  await registerSpecUrlHelper();

  const commands = _path.default.resolve(rootFolder, 'commands-yml', 'commands/**/*.yml');

  (0, _fancyLog.default)('Traversing YML files', commands);
  await _appiumSupport.fs.rimraf(_path.default.resolve(rootFolder, 'docs', 'en', 'commands'));

  const template = _handlebars.default.compile(await _appiumSupport.fs.readFile(_path.default.resolve(rootFolder, 'commands-yml', 'template.md'), 'utf8'), {
    noEscape: true,
    strict: true
  });

  let fileCount = 0;

  for (const filename of await _appiumSupport.fs.glob(commands)) {
    const relativeFilename = _path.default.relative(_path.default.resolve(rootFolder, 'commands-yml'), filename);

    (0, _fancyLog.default)(`Rendering file: ${filename} ${relativeFilename}`);
    const inputYML = await _appiumSupport.fs.readFile(filename, 'utf8');

    const inputJSON = _yamlJs.default.load(inputYML);

    inputJSON.ymlFileName = `/${_path.default.relative(rootFolder, filename)}`;
    const validationErrors = (0, _validate.default)(inputJSON, _validator.validator);

    if (validationErrors) {
      throw new Error(`Data validation error for ${filename}: ${JSON.stringify(validationErrors)}`);
    }

    const markdown = template(inputJSON);

    const ext = _path.default.extname(relativeFilename);

    const markdownPath = `${relativeFilename.substring(0, relativeFilename.length - ext.length)}.md`;

    const outfile = _path.default.resolve(rootFolder, 'docs', 'en', markdownPath);

    (0, _fancyLog.default)(`    Writing to: ${outfile}`);
    await (0, _appiumSupport.mkdirp)(_path.default.dirname(outfile));
    await _appiumSupport.fs.writeFile(outfile, markdown, 'utf8');
    fileCount++;
  }

  (0, _fancyLog.default)(`Done writing ${fileCount} command documents`);
}

async function generateCommandIndex() {
  function getTree(element, path) {
    let node = {
      name: element[0]
    };

    if (!_lodash.default.isArray(element[1])) {
      node.path = `${path}/${element[1]}`;
    } else {
      node.path = `${path}/${element[1][0]}`;
      const name = element[1].shift();
      node.commands = [];

      for (let subElement of element[1]) {
        node.commands.push(getTree(subElement, `${path}/${name}`));
      }
    }

    return node;
  }

  const toc = require(_path.default.resolve(rootFolder, 'docs', 'toc.js'));

  const commandToc = _lodash.default.find(toc.en, value => value.indexOf('Commands') === 0);

  const commands = [];

  for (let el of commandToc[1].slice(1)) {
    commands.push(getTree(el, '/docs/en/commands'));
  }

  const commandTemplate = _handlebars.default.compile(await _appiumSupport.fs.readFile(_path.default.resolve(rootFolder, 'commands-yml', 'api-template.md'), 'utf8'), {
    noEscape: true,
    strict: true
  });

  async function writeIndex(index, commands, indexPath) {
    (0, _fancyLog.default)(`Creating API index '${index}'`);
    const commandMarkdown = commandTemplate({
      commands,
      path: indexPath
    });
    await _appiumSupport.fs.writeFile(index, commandMarkdown, 'utf8');
  }

  const apiIndex = _path.default.resolve(rootFolder, 'docs', 'en', 'about-appium', 'api.md');

  await writeIndex(apiIndex, commands);
  (0, _fancyLog.default)(`Done writing main API index`);

  async function writeIndividualIndexes(command) {
    if (!_appiumSupport.util.hasValue(command.commands)) {
      return;
    }

    const relPath = command.path.startsWith(_path.default.sep) ? command.path.substring(1) : command.path;

    const index = _path.default.resolve(rootFolder, relPath, 'README.md');

    await writeIndex(index, command.commands, command.path);

    for (const el of command.commands) {
      await writeIndividualIndexes(el);
    }
  }

  const index = _path.default.resolve(rootFolder, 'docs', 'en', 'commands', 'README.md');

  await writeIndex(index, commands);

  for (const el of commands) {
    await writeIndividualIndexes(el);
  }
}

async function main() {
  await generateCommands();
  await generateCommandIndex();
}

(0, _asyncbox.asyncify)(main);require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbW1hbmRzLXltbC9wYXJzZS5qcyJdLCJuYW1lcyI6WyJwbGF0Zm9ybVJhbmdlcyIsInhjdWl0ZXN0IiwidWlhdXRvbWF0aW9uIiwiZXNwcmVzc28iLCJ1aWF1dG9tYXRvcjIiLCJ1aWF1dG9tYXRvciIsIndpbmRvd3MiLCJtYWMiLCJhcHBpdW1SYW5nZXMiLCJyb290Rm9sZGVyIiwiX19kaXJuYW1lIiwiSGFuZGxlYmFycyIsInJlZ2lzdGVySGVscGVyIiwidmVyc2lvbkhlbHBlciIsIm9iamVjdCIsIm5hbWUiLCJkcml2ZXJOYW1lIiwiXyIsImlzT2JqZWN0IiwibWluIiwibWF4IiwiaXNBcnJheSIsInN0ciIsInJlcGxhY2UiLCJ0b1VwcGVyQ2FzZSIsImNhcGl0YWxpemVEcml2ZXIiLCJ0b0xvd2VyQ2FzZSIsImxlbmd0aCIsInN1YnN0ciIsImlmRXEiLCJhIiwiYiIsIm9wdHMiLCJmbiIsImludmVyc2UiLCJnZXRCYXNlSG9zdG5hbWUiLCJmdWxsVXJsIiwiYmFzZVVybCIsInVybCIsInBhcnNlIiwiaG9zdG5hbWUiLCJjbGllbnRVcmwiLCJjcmVhdGVVcmxTdHJpbmciLCJ1cmxTdHJpbmdzIiwiaXRlbSIsImtleSIsInZhbHVlIiwidG9QYWlycyIsInVybFN0ciIsIkNMSUVOVF9VUkxfVFlQRVMiLCJwdXNoIiwiam9pbiIsInJlZ2lzdGVyU3BlY1VybEhlbHBlciIsInJvdXRlc0ZpbGUiLCJmcyIsInJlYWRGaWxlIiwicGF0aCIsInJlc29sdmUiLCJyb3V0ZXNGaWxlTGluZXMiLCJzcGxpdCIsInNwZWNVcmwiLCJlbmRwb2ludCIsImluY2x1ZGVzIiwic3RhcnRzV2l0aCIsImluZGV4IiwiaSIsInBhcnNlSW50IiwiaXNVbmRlZmluZWQiLCJFcnJvciIsImdlbmVyYXRlQ29tbWFuZHMiLCJjb21tYW5kcyIsInJpbXJhZiIsInRlbXBsYXRlIiwiY29tcGlsZSIsIm5vRXNjYXBlIiwic3RyaWN0IiwiZmlsZUNvdW50IiwiZmlsZW5hbWUiLCJnbG9iIiwicmVsYXRpdmVGaWxlbmFtZSIsInJlbGF0aXZlIiwiaW5wdXRZTUwiLCJpbnB1dEpTT04iLCJ5YW1sIiwibG9hZCIsInltbEZpbGVOYW1lIiwidmFsaWRhdGlvbkVycm9ycyIsInZhbGlkYXRvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJtYXJrZG93biIsImV4dCIsImV4dG5hbWUiLCJtYXJrZG93blBhdGgiLCJzdWJzdHJpbmciLCJvdXRmaWxlIiwiZGlybmFtZSIsIndyaXRlRmlsZSIsImdlbmVyYXRlQ29tbWFuZEluZGV4IiwiZ2V0VHJlZSIsImVsZW1lbnQiLCJub2RlIiwic2hpZnQiLCJzdWJFbGVtZW50IiwidG9jIiwicmVxdWlyZSIsImNvbW1hbmRUb2MiLCJmaW5kIiwiZW4iLCJpbmRleE9mIiwiZWwiLCJzbGljZSIsImNvbW1hbmRUZW1wbGF0ZSIsIndyaXRlSW5kZXgiLCJpbmRleFBhdGgiLCJjb21tYW5kTWFya2Rvd24iLCJhcGlJbmRleCIsIndyaXRlSW5kaXZpZHVhbEluZGV4ZXMiLCJjb21tYW5kIiwidXRpbCIsImhhc1ZhbHVlIiwicmVsUGF0aCIsInNlcCIsIm1haW4iXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBLE1BQU1BLGNBQWMsR0FBRztBQUNyQkMsRUFBQUEsUUFBUSxFQUFFLENBQUMsS0FBRCxDQURXO0FBRXJCQyxFQUFBQSxZQUFZLEVBQUUsQ0FBQyxLQUFELEVBQVEsS0FBUixDQUZPO0FBR3JCQyxFQUFBQSxRQUFRLEVBQUUsQ0FBQyxHQUFELENBSFc7QUFJckJDLEVBQUFBLFlBQVksRUFBRSxDQUFDLEdBQUQsQ0FKTztBQUtyQkMsRUFBQUEsV0FBVyxFQUFFLENBQUMsS0FBRCxDQUxRO0FBTXJCQyxFQUFBQSxPQUFPLEVBQUUsQ0FBQyxJQUFELENBTlk7QUFPckJDLEVBQUFBLEdBQUcsRUFBRSxDQUFDLEdBQUQ7QUFQZ0IsQ0FBdkI7QUFXQSxNQUFN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LEVBQXlCZ0gsT0FBekIsRUFBa0MsV0FBbEMsQ0FBZDs7QUFDQSxVQUFNUixVQUFVLENBQUNqRCxLQUFELEVBQVFzRCxPQUFPLENBQUNoRCxRQUFoQixFQUEwQmdELE9BQU8sQ0FBQzlELElBQWxDLENBQWhCOztBQUdBLFNBQUssTUFBTXNELEVBQVgsSUFBaUJRLE9BQU8sQ0FBQ2hELFFBQXpCLEVBQW1DO0FBQ2pDLFlBQU0rQyxzQkFBc0IsQ0FBQ1AsRUFBRCxDQUE1QjtBQUNEO0FBQ0Y7O0FBR0QsUUFBTTlDLEtBQUssR0FBR1IsY0FBS0MsT0FBTCxDQUFhaEQsVUFBYixFQUF5QixNQUF6QixFQUFpQyxJQUFqQyxFQUF1QyxVQUF2QyxFQUFtRCxXQUFuRCxDQUFkOztBQUNBLFFBQU13RyxVQUFVLENBQUNqRCxLQUFELEVBQVFNLFFBQVIsQ0FBaEI7O0FBQ0EsT0FBSyxNQUFNd0MsRUFBWCxJQUFpQnhDLFFBQWpCLEVBQTJCO0FBQ3pCLFVBQU0rQyxzQkFBc0IsQ0FBQ1AsRUFBRCxDQUE1QjtBQUNEO0FBQ0Y7O0FBRUQsZUFBZWEsSUFBZixHQUF1QjtBQUNyQixRQUFNdEQsZ0JBQWdCLEVBQXRCO0FBQ0EsUUFBTTZCLG9CQUFvQixFQUExQjtBQUNEOztBQUVELHdCQUFTeUIsSUFBVCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHlhbWwgZnJvbSAneWFtbC1qcyc7XG5pbXBvcnQgeyBmcywgbWtkaXJwLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHZhbGlkYXRlIGZyb20gJ3ZhbGlkYXRlLmpzJztcbmltcG9ydCBIYW5kbGViYXJzIGZyb20gJ2hhbmRsZWJhcnMnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGFzeW5jaWZ5IH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgdmFsaWRhdG9yLCBDTElFTlRfVVJMX1RZUEVTIH0gZnJvbSAnLi92YWxpZGF0b3InO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IGxvZyBmcm9tICdmYW5jeS1sb2cnO1xuaW1wb3J0IGZpbmRSb290IGZyb20gJ2ZpbmQtcm9vdCc7XG5cblxuLy8gV2hhdCByYW5nZSBvZiBwbGF0Zm9ybXMgZG8gdGhlIGRyaXZlcidzIHN1cHBvcnRcbmNvbnN0IHBsYXRmb3JtUmFuZ2VzID0ge1xuICB4Y3VpdGVzdDogWyc5LjMnXSxcbiAgdWlhdXRvbWF0aW9uOiBbJzguMCcsICc5LjMnXSxcbiAgZXNwcmVzc286IFsnPyddLFxuICB1aWF1dG9tYXRvcjI6IFsnPyddLFxuICB1aWF1dG9tYXRvcjogWyc0LjMnXSxcbiAgd2luZG93czogWycxMCddLFxuICBtYWM6IFsnPyddLCAvLyBUT0RPXG59O1xuXG4vLyBXaGVuIHdhcyB0aGUgZHJpdmVyIHN1cHBvcnRlZCBpbiBBcHBpdW0/XG5jb25zdCBhcHBpdW1SYW5nZXMgPSB7XG4gIHhjdWl0ZXN0OiBbJzEuNi4wJ10sXG4gIHVpYXV0b21hdG9yMjogWycxLjYuMCddLFxuICBlc3ByZXNzbzogWycxLjkuMCddLFxuICB3aW5kb3dzOiBbJzEuNi4wJ10sXG4gIG1hYzogWycxLjYuNCddLFxufTtcblxuY29uc3Qgcm9vdEZvbGRlciA9IGZpbmRSb290KF9fZGlybmFtZSk7XG5cbi8vIENyZWF0ZSBIYW5kbGViYXJzIGhlbHBlciB0aGF0IHNob3dzIGEgdmVyc2lvbiByYW5nZVxuSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndmVyc2lvbnMnLCBmdW5jdGlvbiB2ZXJzaW9uSGVscGVyIChvYmplY3QsIG5hbWUsIGRyaXZlck5hbWUpIHtcbiAgaWYgKCFvYmplY3QpIHtcbiAgICByZXR1cm4gJ05vbmUnO1xuICB9XG5cbiAgaWYgKCFfLmlzT2JqZWN0KG9iamVjdCkpIHtcbiAgICBvYmplY3QgPSB7fTtcbiAgfVxuXG4gIGxldCBtaW4gPSBvYmplY3RbbmFtZSA/IGAke25hbWV9X21pbmAgOiAnbWluJ107XG4gIGxldCBtYXggPSBvYmplY3RbbmFtZSA/IGAke25hbWV9X21heGAgOiAnbWF4J107XG5cbiAgaWYgKCFtaW4pIHtcbiAgICBpZiAobmFtZSA9PT0gJ2FwcGl1bScgJiYgXy5pc0FycmF5KGFwcGl1bVJhbmdlc1tkcml2ZXJOYW1lXSkpIHtcbiAgICAgIG1pbiA9IGFwcGl1bVJhbmdlc1tkcml2ZXJOYW1lXVswXTtcbiAgICB9IGVsc2UgaWYgKG5hbWUgPT09ICdwbGF0Zm9ybScgJiYgXy5pc0FycmF5KHBsYXRmb3JtUmFuZ2VzW2RyaXZlck5hbWVdKSkge1xuICAgICAgbWluID0gcGxhdGZvcm1SYW5nZXNbZHJpdmVyTmFtZV1bMF07XG4gICAgfVxuICB9XG5cbiAgaWYgKCFtYXgpIHtcbiAgICBpZiAobmFtZSA9PT0gJ2FwcGl1bScgJiYgYXBwaXVtUmFuZ2VzW2RyaXZlck5hbWVdKSB7XG4gICAgICBtYXggPSBhcHBpdW1SYW5nZXNbZHJpdmVyTmFtZV1bMV07XG4gICAgfSBlbHNlIGlmIChuYW1lID09PSAncGxhdGZvcm0nICYmIHBsYXRmb3JtUmFuZ2VzW2RyaXZlck5hbWVdKSB7XG4gICAgICBtYXggPSBwbGF0Zm9ybVJhbmdlc1tkcml2ZXJOYW1lXVsxXTtcbiAgICB9XG4gIH1cblxuICBpZiAoIW1pbiAmJiAhbWF4KSB7XG4gICAgcmV0dXJuICdBbGwnO1xuICB9IGVsc2UgaWYgKCFtYXgpIHtcbiAgICByZXR1cm4gYCR7bWlufStgO1xuICB9IGVsc2UgaWYgKCFtaW4pIHtcbiAgICByZXR1cm4gYDw9ICR7bWF4fWA7XG4gIH1cblxuICByZXR1cm4gYCR7bWlufSB0byAke21heH1gO1xufSk7XG5cbkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2h5cGhlbmF0ZScsIChzdHIpID0+IHN0ci5yZXBsYWNlKCdfJywgJy0nKSk7XG5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd1cHBlcmNhc2UnLCAoc3RyKSA9PiBzdHIudG9VcHBlckNhc2UoKSk7XG5cbkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2NhcGl0YWxpemUnLCBmdW5jdGlvbiBjYXBpdGFsaXplRHJpdmVyIChkcml2ZXJOYW1lKSB7XG4gIHN3aXRjaCAoZHJpdmVyTmFtZS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgY2FzZSAneGN1aXRlc3QnOlxuICAgICAgcmV0dXJuICdYQ1VJVGVzdCc7XG4gICAgY2FzZSAndWlhdXRvbWF0aW9uJzpcbiAgICAgIHJldHVybiAnVUlBdXRvbWF0aW9uJztcbiAgICBjYXNlICd1aWF1dG9tYXRvcjInOlxuICAgICAgcmV0dXJuICdVaUF1dG9tYXRvcjInO1xuICAgIGNhc2UgJ3VpYXV0b21hdG9yJzpcbiAgICAgIHJldHVybiAnVWlBdXRvbWF0b3InO1xuICAgIGNhc2UgJ2VzcHJlc3NvJzpcbiAgICAgIHJldHVybiAnRXNwcmVzc28nO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gZHJpdmVyTmFtZS5sZW5ndGggPT09IDAgPyBkcml2ZXJOYW1lIDogZHJpdmVyTmFtZVswXS50b1VwcGVyQ2FzZSgpICsgZHJpdmVyTmFtZS5zdWJzdHIoMSk7XG4gIH1cbn0pO1xuXG5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZl9lcScsIGZ1bmN0aW9uIGlmRXEgKGEsIGIsIG9wdHMpIHtcbiAgaWYgKGEgPT09IGIpIHtcbiAgICByZXR1cm4gb3B0cy5mbih0aGlzKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gb3B0cy5pbnZlcnNlKHRoaXMpO1xuICB9XG59KTtcblxuZnVuY3Rpb24gZ2V0QmFzZUhvc3RuYW1lIChmdWxsVXJsKSB7XG4gIGNvbnN0IGJhc2VVcmwgPSB1cmwucGFyc2UoZnVsbFVybCk7XG4gIHJldHVybiBiYXNlVXJsLmhvc3RuYW1lO1xufVxuXG5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdiYXNlX3VybCcsIGZ1bmN0aW9uIGJhc2VVcmwgKGZ1bGxVcmwpIHtcbiAgcmV0dXJuIGdldEJhc2VIb3N0bmFtZShmdWxsVXJsKTtcbn0pO1xuXG5IYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdjbGllbnRfdXJsJywgZnVuY3Rpb24gY2xpZW50VXJsIChjbGllbnRVcmwpIHtcbiAgaWYgKCFjbGllbnRVcmwpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBjcmVhdGVVcmxTdHJpbmcgPSBmdW5jdGlvbiBjcmVhdGVVcmxTdHJpbmcgKGNsaWVudFVybCwgbmFtZSA9IGdldEJhc2VIb3N0bmFtZShjbGllbnRVcmwpKSB7XG4gICAgcmV0dXJuIGBbJHtuYW1lfV0oJHtjbGllbnRVcmx9KWA7XG4gIH07XG5cbiAgaWYgKCFfLmlzQXJyYXkoY2xpZW50VXJsKSkge1xuICAgIHJldHVybiBjcmVhdGVVcmxTdHJpbmcoY2xpZW50VXJsKTtcbiAgfVxuXG4gIGxldCB1cmxTdHJpbmdzID0gW107XG4gIGZvciAoY29uc3QgaXRlbSBvZiBjbGllbnRVcmwpIHtcbiAgICBmb3IgKGxldCBba2V5LCB2YWx1ZV0gb2YgXy50b1BhaXJzKGl0ZW0pKSB7XG4gICAgICBrZXkgPSBrZXkudG9Mb3dlckNhc2UoKTtcbiAgICAgIGNvbnN0IHVybFN0ciA9IENMSUVOVF9VUkxfVFlQRVNba2V5XSA9PT0gJ2hvc3RuYW1lJ1xuICAgICAgICA/IGNyZWF0ZVVybFN0cmluZyh2YWx1ZSlcbiAgICAgICAgOiBjcmVhdGVVcmxTdHJpbmcodmFsdWUsIENMSUVOVF9VUkxfVFlQRVNba2V5XSk7XG4gICAgICB1cmxTdHJpbmdzLnB1c2godXJsU3RyKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVybFN0cmluZ3Muam9pbignICcpO1xufSk7XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyU3BlY1VybEhlbHBlciAoKSB7XG4gIGNvbnN0IHJvdXRlc0ZpbGUgPSBhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUocm9vdEZvbGRlciwgJ25vZGVfbW9kdWxlcycsICdhcHBpdW0tYmFzZS1kcml2ZXInLCAnbGliJywgJ3Byb3RvY29sJywgJ3JvdXRlcy5qcycpLCAndXRmOCcpO1xuICBjb25zdCByb3V0ZXNGaWxlTGluZXMgPSByb3V0ZXNGaWxlLnNwbGl0KCdcXG4nKTtcblxuICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdzcGVjX3VybCcsIGZ1bmN0aW9uIHNwZWNVcmwgKHNwZWNVcmwsIGVuZHBvaW50KSB7XG4gICAgLy8gcmV0dXJuIHRoZSB1cmwgaWYgaXQgaXMgbm90IGEgbGluayB0byBvdXIgcm91dGVzIGRvY1xuICAgIGlmICghc3BlY1VybC5pbmNsdWRlcygncm91dGVzLmpzJykpIHtcbiAgICAgIHJldHVybiBzcGVjVXJsO1xuICAgIH1cbiAgICAvLyBtYWtlIHN1cmUgaXQgaXMgYSBmdWxsIHVybFxuICAgIGlmIChzcGVjVXJsLnN0YXJ0c1dpdGgoJ3JvdXRlcy5qcycpKSB7XG4gICAgICBzcGVjVXJsID0gYGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtLWJhc2UtZHJpdmVyL2Jsb2IvbWFzdGVyL2xpYi9wcm90b2NvbC8ke3NwZWNVcmx9YDtcbiAgICB9XG5cbiAgICAvLyBzdHJpcCBvZmYgYW55IGxpbmUgbnVtYmVyc1xuICAgIHNwZWNVcmwgPSBzcGVjVXJsLnNwbGl0KCcjTCcpWzBdO1xuXG4gICAgLy8gdGhlIGVuZHBvaW50IGhlcmUgaXMgb2Z0ZW4gYHNlc3Npb25faWRgIGFuZCB3ZSBuZWVkIGBzZXNzaW9uSWRgXG4gICAgZW5kcG9pbnQgPSBlbmRwb2ludC5yZXBsYWNlKCdzZXNzaW9uX2lkJywgJ3Nlc3Npb25JZCcpO1xuICAgIC8vIGFuZCBgZWxlbWVudF9pZGAgYW5kIHdlIG5lZWQgYGVsZW1lbnRJZGBcbiAgICBlbmRwb2ludCA9IGVuZHBvaW50LnJlcGxhY2UoJ2VsZW1lbnRfaWQnLCAnZWxlbWVudElkJyk7XG5cbiAgICAvLyBmaW5kIHRoZSBsaW5lIG51bWJlciBmb3IgdGhpcyBlbmRwb2ludFxuICAgIGxldCBpbmRleDtcbiAgICBmb3IgKGNvbnN0IGkgaW4gcm91dGVzRmlsZUxpbmVzKSB7XG4gICAgICBpZiAocm91dGVzRmlsZUxpbmVzW2ldLmluY2x1ZGVzKGVuZHBvaW50KSkge1xuICAgICAgICAvLyBsaW5lIG51bWJlcnMgYXJlIDEtaW5kZXhlZFxuICAgICAgICBpbmRleCA9IHBhcnNlSW50KGksIDEwKSArIDE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoXy5pc1VuZGVmaW5lZChpbmRleCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGZpbmQgZW50cnkgaW4gJ2FwcGl1bS1iYXNlLWRyaXZlciNyb3V0ZXMnIGZvciBlbmRwb2ludCAnJHtlbmRwb2ludH0nYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGAke3NwZWNVcmx9I0wke2luZGV4fWA7XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZUNvbW1hbmRzICgpIHtcbiAgYXdhaXQgcmVnaXN0ZXJTcGVjVXJsSGVscGVyKCk7XG5cbiAgY29uc3QgY29tbWFuZHMgPSBwYXRoLnJlc29sdmUocm9vdEZvbGRlciwgJ2NvbW1hbmRzLXltbCcsICdjb21tYW5kcy8qKi8qLnltbCcpO1xuICBsb2coJ1RyYXZlcnNpbmcgWU1MIGZpbGVzJywgY29tbWFuZHMpO1xuICBhd2FpdCBmcy5yaW1yYWYocGF0aC5yZXNvbHZlKHJvb3RGb2xkZXIsICdkb2NzJywgJ2VuJywgJ2NvbW1hbmRzJykpO1xuXG4gIC8vIGdldCB0aGUgdGVtcGxhdGUgZnJvbSB3aGljaCB0aGUgbWQgZmlsZXMgd2lsbCBiZSBjcmVhdGVkXG4gIGNvbnN0IHRlbXBsYXRlID0gSGFuZGxlYmFycy5jb21waWxlKGF3YWl0IGZzLnJlYWRGaWxlKHBhdGgucmVzb2x2ZShyb290Rm9sZGVyLCAnY29tbWFuZHMteW1sJywgJ3RlbXBsYXRlLm1kJyksICd1dGY4JyksIHtub0VzY2FwZTogdHJ1ZSwgc3RyaWN0OiB0cnVlfSk7XG5cbiAgbGV0IGZpbGVDb3VudCA9IDA7XG4gIGZvciAoY29uc3QgZmlsZW5hbWUgb2YgYXdhaXQgZnMuZ2xvYihjb21tYW5kcykpIHtcbiAgICBjb25zdCByZWxhdGl2ZUZpbGVuYW1lID0gcGF0aC5yZWxhdGl2ZShwYXRoLnJlc29sdmUocm9vdEZvbGRlciwgJ2NvbW1hbmRzLXltbCcpLCBmaWxlbmFtZSk7XG4gICAgbG9nKGBSZW5kZXJpbmcgZmlsZTogJHtmaWxlbmFtZX0gJHtyZWxhdGl2ZUZpbGVuYW1lfWApO1xuXG4gICAgLy8gVHJhbnNsYXRlIHRoZSBZTUwgc3BlY3MgdG8gSlNPTlxuICAgIGNvbnN0IGlucHV0WU1MID0gYXdhaXQgZnMucmVhZEZpbGUoZmlsZW5hbWUsICd1dGY4Jyk7XG4gICAgY29uc3QgaW5wdXRKU09OID0geWFtbC5sb2FkKGlucHV0WU1MKTtcbiAgICBpbnB1dEpTT04ueW1sRmlsZU5hbWUgPSBgLyR7cGF0aC5yZWxhdGl2ZShyb290Rm9sZGVyLCBmaWxlbmFtZSl9YDtcbiAgICBjb25zdCB2YWxpZGF0aW9uRXJyb3JzID0gdmFsaWRhdGUoaW5wdXRKU09OLCB2YWxpZGF0b3IpO1xuICAgIGlmICh2YWxpZGF0aW9uRXJyb3JzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYERhdGEgdmFsaWRhdGlvbiBlcnJvciBmb3IgJHtmaWxlbmFtZX06ICR7SlNPTi5zdHJpbmdpZnkodmFsaWRhdGlvbkVycm9ycyl9YCk7XG4gICAgfVxuXG4gICAgLy8gUGFzcyB0aGUgaW5wdXRKUyBpbnRvIG91ciBIYW5kbGViYXJzIHRlbXBsYXRlXG4gICAgY29uc3QgbWFya2Rvd24gPSB0ZW1wbGF0ZShpbnB1dEpTT04pO1xuXG4gICAgLy8gV3JpdGUgdGhlIG1hcmtkb3duIHRvIGl0cyByaWdodCBwbGFjZVxuICAgIGNvbnN0IGV4dCA9IHBhdGguZXh0bmFtZShyZWxhdGl2ZUZpbGVuYW1lKTtcbiAgICBjb25zdCBtYXJrZG93blBhdGggPSBgJHtyZWxhdGl2ZUZpbGVuYW1lLnN1YnN0cmluZygwLCByZWxhdGl2ZUZpbGVuYW1lLmxlbmd0aCAtIGV4dC5sZW5ndGgpfS5tZGA7XG4gICAgY29uc3Qgb3V0ZmlsZSA9IHBhdGgucmVzb2x2ZShyb290Rm9sZGVyLCAnZG9jcycsICdlbicsIG1hcmtkb3duUGF0aCk7XG4gICAgbG9nKGAgICAgV3JpdGluZyB0bzogJHtvdXRmaWxlfWApO1xuICAgIGF3YWl0IG1rZGlycChwYXRoLmRpcm5hbWUob3V0ZmlsZSkpO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShvdXRmaWxlLCBtYXJrZG93biwgJ3V0ZjgnKTtcblxuICAgIGZpbGVDb3VudCsrO1xuICB9XG4gIGxvZyhgRG9uZSB3cml0aW5nICR7ZmlsZUNvdW50fSBjb21tYW5kIGRvY3VtZW50c2ApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZUNvbW1hbmRJbmRleCAoKSB7XG4gIGZ1bmN0aW9uIGdldFRyZWUgKGVsZW1lbnQsIHBhdGgpIHtcbiAgICBsZXQgbm9kZSA9IHtcbiAgICAgIG5hbWU6IGVsZW1lbnRbMF0sXG4gICAgfTtcbiAgICBpZiAoIV8uaXNBcnJheShlbGVtZW50WzFdKSkge1xuICAgICAgbm9kZS5wYXRoID0gYCR7cGF0aH0vJHtlbGVtZW50WzFdfWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vZGUucGF0aCA9IGAke3BhdGh9LyR7ZWxlbWVudFsxXVswXX1gO1xuICAgICAgY29uc3QgbmFtZSA9IGVsZW1lbnRbMV0uc2hpZnQoKTtcbiAgICAgIG5vZGUuY29tbWFuZHMgPSBbXTtcbiAgICAgIGZvciAobGV0IHN1YkVsZW1lbnQgb2YgZWxlbWVudFsxXSkge1xuICAgICAgICBub2RlLmNvbW1hbmRzLnB1c2goZ2V0VHJlZShzdWJFbGVtZW50LCBgJHtwYXRofS8ke25hbWV9YCkpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbm9kZTtcbiAgfVxuXG4gIC8vIHBhcnNlIHRoZSB0b2MuanMgZmlsZSBhbmQgZ2V0IHRoZSBjb21tYW5kcyBpbnRvIHRoZSBmb3JtIG9mXG4gIC8vICAge2NvbW1hbmRzOiBbe25hbWU6ICcnLCBwYXRoOiAnJ30sIHtuYW1lOiAnJywgY29tbWFuZHM6IFsuLi5dfV19XG4gIGNvbnN0IHRvYyA9IHJlcXVpcmUocGF0aC5yZXNvbHZlKHJvb3RGb2xkZXIsICdkb2NzJywgJ3RvYy5qcycpKTtcbiAgY29uc3QgY29tbWFuZFRvYyA9IF8uZmluZCh0b2MuZW4sICh2YWx1ZSkgPT4gdmFsdWUuaW5kZXhPZignQ29tbWFuZHMnKSA9PT0gMCk7XG4gIGNvbnN0IGNvbW1hbmRzID0gW107XG4gIGZvciAobGV0IGVsIG9mIGNvbW1hbmRUb2NbMV0uc2xpY2UoMSkpIHtcbiAgICBjb21tYW5kcy5wdXNoKGdldFRyZWUoZWwsICcvZG9jcy9lbi9jb21tYW5kcycpKTtcbiAgfVxuXG4gIGNvbnN0IGNvbW1hbmRUZW1wbGF0ZSA9IEhhbmRsZWJhcnMuY29tcGlsZShhd2FpdCBmcy5yZWFkRmlsZShwYXRoLnJlc29sdmUocm9vdEZvbGRlciwgJ2NvbW1hbmRzLXltbCcsICdhcGktdGVtcGxhdGUubWQnKSwgJ3V0ZjgnKSwge25vRXNjYXBlOiB0cnVlLCBzdHJpY3Q6IHRydWV9KTtcblxuICBhc3luYyBmdW5jdGlvbiB3cml0ZUluZGV4IChpbmRleCwgY29tbWFuZHMsIGluZGV4UGF0aCkge1xuICAgIGxvZyhgQ3JlYXRpbmcgQVBJIGluZGV4ICcke2luZGV4fSdgKTtcbiAgICBjb25zdCBjb21tYW5kTWFya2Rvd24gPSBjb21tYW5kVGVtcGxhdGUoe1xuICAgICAgY29tbWFuZHMsXG4gICAgICBwYXRoOiBpbmRleFBhdGgsXG4gICAgfSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGluZGV4LCBjb21tYW5kTWFya2Rvd24sICd1dGY4Jyk7XG4gIH1cblxuICBjb25zdCBhcGlJbmRleCA9IHBhdGgucmVzb2x2ZShyb290Rm9sZGVyLCAnZG9jcycsICdlbicsICdhYm91dC1hcHBpdW0nLCAnYXBpLm1kJyk7XG4gIGF3YWl0IHdyaXRlSW5kZXgoYXBpSW5kZXgsIGNvbW1hbmRzKTtcbiAgbG9nKGBEb25lIHdyaXRpbmcgbWFpbiBBUEkgaW5kZXhgKTtcblxuICBhc3luYyBmdW5jdGlvbiB3cml0ZUluZGl2aWR1YWxJbmRleGVzIChjb21tYW5kKSB7XG4gICAgaWYgKCF1dGlsLmhhc1ZhbHVlKGNvbW1hbmQuY29tbWFuZHMpKSB7XG4gICAgICAvLyB0aGlzIGlzIGEgbGVhZiwgc28gZW5kXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gd3JpdGUgdGhpcyBub2RlXG4gICAgY29uc3QgcmVsUGF0aCA9IGNvbW1hbmQucGF0aC5zdGFydHNXaXRoKHBhdGguc2VwKSA/IGNvbW1hbmQucGF0aC5zdWJzdHJpbmcoMSkgOiBjb21tYW5kLnBhdGg7XG4gICAgY29uc3QgaW5kZXggPSBwYXRoLnJlc29sdmUocm9vdEZvbGRlciwgcmVsUGF0aCwgJ1JFQURNRS5tZCcpO1xuICAgIGF3YWl0IHdyaXRlSW5kZXgoaW5kZXgsIGNvbW1hbmQuY29tbWFuZHMsIGNvbW1hbmQucGF0aCk7XG5cbiAgICAvLyBnbyB0aHJvdWdoIGFsbCB0aGUgc3ViLWNvbW1hbmRzXG4gICAgZm9yIChjb25zdCBlbCBvZiBjb21tYW5kLmNvbW1hbmRzKSB7XG4gICAgICBhd2FpdCB3cml0ZUluZGl2aWR1YWxJbmRleGVzKGVsKTtcbiAgICB9XG4gIH1cblxuICAvLyBnbyB0aHJvdWdoIHRoZSBmdWxsIHRyZWUgYW5kIGdlbmVyYXRlIHJlYWRtZSBmaWxlc1xuICBjb25zdCBpbmRleCA9IHBhdGgucmVzb2x2ZShyb290Rm9sZGVyLCAnZG9jcycsICdlbicsICdjb21tYW5kcycsICdSRUFETUUubWQnKTtcbiAgYXdhaXQgd3JpdGVJbmRleChpbmRleCwgY29tbWFuZHMpO1xuICBmb3IgKGNvbnN0IGVsIG9mIGNvbW1hbmRzKSB7XG4gICAgYXdhaXQgd3JpdGVJbmRpdmlkdWFsSW5kZXhlcyhlbCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gbWFpbiAoKSB7XG4gIGF3YWl0IGdlbmVyYXRlQ29tbWFuZHMoKTtcbiAgYXdhaXQgZ2VuZXJhdGVDb21tYW5kSW5kZXgoKTtcbn1cblxuYXN5bmNpZnkobWFpbik7XG4iXSwiZmlsZSI6ImNvbW1hbmRzLXltbC9wYXJzZS5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
